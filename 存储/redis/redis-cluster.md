# redis cluster

## 集群总线端口
每个redis集群节点都需要开放两个TCP连接：一个用于为客户端提供服务（6379），另一个端口（**集群总线端口**）。默认情况下，集群总线端口是用过在数据端口上+10000来设置的；但是你可以在配置中覆盖它`cluster-port`。

集群总线是一种使用二进制协议的节点到节点的通信通道，由于带宽和处理时间较小，更适合在节点之间交换信息。**节点使用集群总线进行故障检测、配置更新、故障转移授权等**。客户端永远不应尝试与集群总线端口进行通信，而应使用 Redis 命令端口。但是，请确保在防火墙中打开这两个端口，否则 Redis 集群节点将无法通信。

## 在集群模式下，Redis 的 Key 是如何寻址的？
redis 的key寻址用的是hash slot算法

Redis 集群中有**16384**个哈希槽，为了计算给定键的哈希槽，我们只需对键的 `CRC16` 取模 16384 即可。

集群中的每个节点负责一部分的hash槽，比如当前集群有A、B、C个节点，每个节点上的哈希槽数 =16384/3，那么就有：

节点A负责0~5500号哈希槽
节点B负责5501~11000号哈希槽
节点C负责11001~16383号哈希槽

这是的添加和删除集群节点变得容易。将哈希槽从一个节点移动到另一个节点不需要停止任何操作。

### 控制多个key在同一个hash slot
**redis cluster支持多个key的操作，只要单个命令执行设计的key在同一个hash槽**。可以使用**哈希标签**的功能强制多个key在同一个hash槽。

从左到右第一个`{}`包裹有字符串，则仅对改字符串的内容进行hash。键`user:{123}:profile`和`user:{123}:account`保证位于同一哈希槽中，因为它们共享相同的哈希标签。因此，您可以在同一个多键操作中对这两个键进行操作。

> 当对key所属的哈希槽进行重新分片是，多件操作可能会变得不可用。因为分片过程中，这些key可能不在同一个slot中。

## 集群一致性保证
redis cluster不保证**强一致性**。

原因：
- 丢失写入的第一个原因是使用**异步复制**
- 发生在网络分区期间，客户端与少数实例（至少包括一个主实例）隔离。


## 客户端配置注意点
> 启动节点不需要是集群的所有节点。重要的是至少有一个节点是可达的

客户端可以通过任意一个节点访问整个集群，redis会自动**重定向**到正确的节点。认证的客户端配置（分配所有的节点的ip和端口号），会有更好的性能，因为他会缓存哈希槽和ip地址之间的映射，以便使用正确的节点的正确连接。


## slave节点扩展读取
默认情况下slave节点不提供读写服务，仅作为备份。我们可以使用`READONLY`命令从slave读取数据。（需要注意的时，副本中的数据可能与主节点不一致）