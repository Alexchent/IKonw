# 分布式事务

## CAP理论
- Consistency 一致性
- Availability 可用性
- Partition tolerance（分区容忍性）

CAP理论说的就是：一个分布式系统，不可能同时做到这三点。大多数采用最终一致性方案
![](https://pic4.zhimg.com/80/v2-3b7731ca7da1d609b93f536563f8f05f_1440w.webp)


## 解决方案 BASE
BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（**最终一致性**）三个短语的简写，BASE是对CAP中一致性和可用性权衡的结果。

核心思想：即使无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。

### 2PC
2阶段提交，将整个事务分成两个阶段，准备阶段、提交阶段


### TCC
将整个事务分成try、commit、cancel三个阶段

### 可靠消息最终一致性
可靠消息最终一致性方案是指当事务发起方执行完成本地事务后并发出一条消息，事务参与方（消息消费者）一定能够接收消息并处理事务成功，此方案强调的是只要消息发给事务参与方最终事务要达到一致。

可靠消息最终一致性需要解决3个**关键问题**
1. 本地事务与发送消息的原子性
> 先进行数据库操作，在发送消息，如果发送消息超时导致事务回滚，但是消息实际发送成功
1. 消费者接收消息的可靠性
2. 消息重复消费问题

解决方案：
1. 本地消息表方案
通过定时任务，将消息发送给消息中间件，发送成功后更新任务状态(删除)
1. 消费者可靠性
通过ack手动提交确认机制保障
1. 重复消费问题
通过乐观锁实现幂等性

### 最大努力通知
1. 消息发送方会尽最大努力将业务处理结果发送给消费者，有一定的重试机制
2. 但是消费者如果在规定时间和次数内没有响应，则需要消费方主动调用查询接口来满足需求

与可靠消息最终一致性的不同点：
1. 可靠消息一致性，发起通知方需要保证将消息发出去，并且将消息发到接收通知方，消息的可靠性关键由发起通知方来保证。最大努力通知，不保证消费者一定接收到消息，可靠性需要消费方来保证。

**典型场景**，支付结果通知，一般重试3次，如果没有返回确认，则需要主要调用接口查询支付结果。